Attribute VB_Name = "Module1"
Public gOrderID As Long


Function NextOrderID() As Long
    gOrderID = gOrderID + 1
    NextOrderID = gOrderID
End Function


Function DoBuy(code As String) As Boolean
    Dim oid As Long

    oid = NextOrderID()
    result = RssMarginOpenOrder_v(oid, code, 3, 0, 1, 4, 100, 0, , 1, , 0)
    Call AppendLog(code, "DoBuy result=" & CStr(result))
    DoBuy = True
End Function


Function DoSell(code As String) As Boolean
    Dim oid As Long

    oid = NextOrderID()
    result = RssMarginOpenOrder_v(oid, code, 1, 0, 1, 4, 100, 0, , 1, , 0)
    Call AppendLog(code, "DoSell result=" & CStr(result))
    DoSell = True
End Function


Function DoRepay(code As String) As Boolean
    Dim ws As Worksheet
    Dim row As Long
    Dim oid As Long
    Dim qty As String
    Dim tanka As String
    Dim tatebi As String
    Dim marketStr As String
    Dim marketCode As String
    Dim shinyo As String
    Dim result As String

    Set ws = ThisWorkbook.Sheets("Positions")

    row = FindPositionRow(code)
    If row = 0 Then
        DoRepay = False
        Exit Function
    End If

    qty = CStr(ws.Cells(row, "I").Value)
    tanka = Format$(ws.Cells(row, "J").Value, "0.00")
    tatebi = CStr(ws.Cells(row, "K").Value)
    marketStr = Trim(ws.Cells(row, "D").Value)
    shinyo = CStr(ws.Cells(row, "E").Value)

    Select Case marketStr
        Case "東証": marketCode = "1"
        Case "JNX": marketCode = "4"
        Case "JAX": marketCode = "5"
        Case "Chi-X": marketCode = "6"
        Case Else: DoRepay = False: Exit Function
    End Select

    oid = NextOrderID()

    result = RssMarginCloseOrder_V( _
        oid, _
        CStr(code), _
        "1", _
        "0", _
        "0", _
        "4", _
        qty, _
        "0", _
        "0", _
        "1", _
        "", _
        "0", _
        tatebi, _
        tanka, _
        marketCode, _
        "0", _
        "", _
        "", _
        "0")

    DoRepay = True
End Function


Sub AppendLog(code As String, message As String)
    Dim ws As Worksheet
    Dim nextRow As Long

    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("Logs")
    On Error GoTo 0

    If ws Is Nothing Then
        MsgBox "Logs シートが見つかりません。", vbExclamation
        Exit Sub
    End If

    nextRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).row + 1
    If nextRow < 2 Then nextRow = 2 ' ヘッダーが1行目にある前提

    With ws
        .Cells(nextRow, 1).Value = Now
        .Cells(nextRow, 2).Value = code
        .Cells(nextRow, 3).Value = message
    End With
End Sub


Sub ClearLogs()
    Dim ws As Worksheet

    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("Logs")
    On Error GoTo 0

    If ws Is Nothing Then
        MsgBox "Logs シートが見つかりません。", vbExclamation
        Exit Sub
    End If

    ' 2行目以降を削除（ヘッダーは残す）
    ws.Rows("2:" & ws.Rows.Count).ClearContents
End Sub


Function FindPositionRow(code As String) As Long
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim r As Long

    Set ws = ThisWorkbook.Sheets("Positions")
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).row

    ' 最終行が '-------- の場合は1行上から検索開始
    If ws.Cells(lastRow, "A").Value = "--------" Then
        lastRow = lastRow - 1
    End If

    ' 下から上へ検索（最新の建玉を優先）
    For r = lastRow To 3 Step -1
        If ws.Cells(r, "A").Value = code Then
            FindPositionRow = r
            Exit Function
        End If
    Next r

    FindPositionRow = 0
End Function



Attribute VB_Name = "Module1"
Public gOrderID As Long


Function NextOrderID() As Long
    gOrderID = gOrderID + 1
    NextOrderID = gOrderID
End Function


Function DoBuy(code As String) As Boolean
    Dim oid As Long

    oid = NextOrderID()
    result = RssMarginOpenOrder_v(oid, code, 3, 0, 1, 4, 100, 0, , 1, , 0)
    Call AppendLog(code, "DoBuy result=" & CStr(result))
    DoBuy = True
End Function


Function DoSell(code As String) As Boolean
    Dim oid As Long

    oid = NextOrderID()
    result = RssMarginOpenOrder_v(oid, code, 1, 0, 1, 4, 100, 0, , 1, , 0)
    Call AppendLog(code, "DoSell result=" & CStr(result))
    DoSell = True
End Function


Function DoRepay(code As String) As Boolean
    Dim oid As Long
    Dim row As Long
    Dim ws As Worksheet
    Dim qty As Long
    Dim tanka As Double
    Dim tatebi As Long
    Dim marketStr As String
    Dim marketCode As Long
    Dim shinyo As Long
    Dim result As Variant

    Set ws = ThisWorkbook.Sheets("Positions")

    ' 建玉行を探す
    row = FindPositionRow(code)
    If row = 0 Then
        Call AppendLog(code, "DoRepay: 建玉が見つかりません")
        DoRepay = False
        Exit Function
    End If

    ' 必要な値を取得
    qty = CLng(ws.Cells(row, "G").Value)
    tanka = CDbl(ws.Cells(row, "I").Value)
    tatebi = CLng(ws.Cells(row, "J").Value)
    marketStr = Trim(ws.Cells(row, "D").Value)
    shinyo = CLng(ws.Cells(row, "E").Value)

    ' 建市場コードに変換
    Select Case marketStr
        Case "東証": marketCode = 1
        Case "JNX": marketCode = 4
        Case "JAX": marketCode = 5
        Case "Chi-X": marketCode = 6
        Case Else
            Call AppendLog(code, "DoRepay: 未知の建市場 '" & marketStr & "'")
            DoRepay = False
            Exit Function
    End Select

    ' 発注ID
    oid = NextOrderID()

    ' 返済注文（成行）
    result = RssMarginCloseOrder_v(oid, code, 1, 0, 1, shinyo, qty, 0, "", 1, "", 0, tatebi, tanka, marketCode, "", "", "", "")
    Call AppendLog(code, "DoRepay result=" & CStr(result))
    DoRepay = True
End Function


Sub AppendLog(code As String, message As String)
    Dim ws As Worksheet
    Dim nextRow As Long

    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("Logs")
    On Error GoTo 0

    If ws Is Nothing Then
        MsgBox "Logs シートが見つかりません。", vbExclamation
        Exit Sub
    End If

    nextRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).row + 1
    If nextRow < 2 Then nextRow = 2 ' ヘッダーが1行目にある前提

    With ws
        .Cells(nextRow, 1).Value = Now
        .Cells(nextRow, 2).Value = code
        .Cells(nextRow, 3).Value = message
    End With
End Sub


Sub ClearLogs()
    Dim ws As Worksheet

    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("Logs")
    On Error GoTo 0

    If ws Is Nothing Then
        MsgBox "Logs シートが見つかりません。", vbExclamation
        Exit Sub
    End If

    ' 2行目以降を削除（ヘッダーは残す）
    ws.Rows("2:" & ws.Rows.Count).ClearContents
End Sub


Function FindPositionRow(code As String) As Long
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim r As Long

    Set ws = ThisWorkbook.Sheets("Positions")
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row

    ' 最終行が '-------- の場合は1行上から検索開始
    If ws.Cells(lastRow, "A").Value = "--------" Then
        lastRow = lastRow - 1
    End If

    ' 下から上へ検索（最新の建玉を優先）
    For r = lastRow To 3 Step -1
        If ws.Cells(r, "A").Value = code Then
            FindPositionRow = r
            Exit Function
        End If
    Next r

    FindPositionRow = 0
End Function


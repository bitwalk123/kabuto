Attribute VB_Name = "Module1"
Public gOrderID As Long


Function NextOrderID() As Long
    gOrderID = gOrderID + 1
    NextOrderID = gOrderID
End Function


Function DoBuy(code As String) As Boolean
    Dim oid As Long

    oid = NextOrderID()
    result = RssMarginOpenOrder_v(oid, code, 3, 0, 1, 4, 100, 0, , 1, , 0)
    Call AppendLog(code, "DoBuy result=" & CStr(result))
    DoBuy = True
End Function


Function DoSell(code As String) As Boolean
    Dim oid As Long

    oid = NextOrderID()
    result = RssMarginOpenOrder_v(oid, code, 1, 0, 1, 4, 100, 0, , 1, , 0)
    Call AppendLog(code, "DoSell result=" & CStr(result))
    DoSell = True
End Function


Function DoRepay(code As String) As Boolean
    Dim ws As Worksheet
    Dim row As Long
    Dim oid As Long
    Dim qty As Long
    Dim tanka As Double
    Dim tatebi As String
    Dim marketStr As String
    Dim marketCode As Long
    Dim shinyo As String
    Dim result As Variant

    Set ws = ThisWorkbook.Sheets("Positions")

    ' 建玉行を探す
    row = FindPositionRow(code)
    If row = 0 Then
        Call AppendLog(code, "DoRepay: 建玉が見つかりません")
        DoRepay = False
        Exit Function
    End If

    ' 必要な値を取得
    qty = CLng(ws.Cells(row, "H").Value)          ' 建玉数量
    tanka = CDbl(ws.Cells(row, "I").Value)        ' 建値
    tatebi = CStr(ws.Cells(row, "J").Value)       ' 建日 (YYYYMMDD)
    marketStr = Trim(ws.Cells(row, "D").Value)    ' 建市場（文字列）
    ' 信用区分（本当は 1〜4 にマッピングすべきだが、まずは型だけ合わせておく）
    shinyo = CStr(ws.Cells(row, "E").Value)

    ' 建市場コードに変換（PDF 準拠）
    Select Case marketStr
        Case "東証": marketCode = 1
        Case "JNX":  marketCode = 4
        Case "JAX":  marketCode = 5
        Case "Chi-X": marketCode = 6
        Case Else
            Call AppendLog(code, "DoRepay: 未知の建市場 '" & marketStr & "'")
            DoRepay = False
            Exit Function
    End Select

    ' 発注ID
    oid = NextOrderID()

    ' ★ ここが本題：引数の「型」を PDF に合わせる ★
    '  2:銘柄コード        → 文字列
    '  3:売買区分          → 文字列 ("1":売埋)
    '  4:注文区分          → 文字列 ("0":通常)
    '  5:SOR区分           → 文字列 ("0":通常)
    '  6:信用区分          → 文字列
    '  7:注文数量          → 数値
    '  8:価格区分          → 文字列 ("0":成行)
    '  9:注文価格          → 数値（成行なので 0）
    ' 10:執行条件          → 文字列 ("1":本日中)
    ' 11:注文期限          → 文字列（空でOK）
    ' 12:口座区分          → 文字列 ("0":特定)
    ' 13:建日              → 文字列
    ' 14:建単価            → 数値
    ' 15:建市場            → 数値
    ' 16:逆指値条件価格    → 数値（0）
    ' 17:逆指値条件区分    → 文字列（空）
    ' 18:逆指値価格区分    → 文字列（空）
    ' 19:逆指値価格        → 数値（0）

    result = RssMarginCloseOrder_v( _
                oid, _
                CStr(code), _          ' 2:銘柄コード（文字列）
                "1", _                 ' 3:売買区分（売埋）
                "0", _                 ' 4:注文区分（通常）
                "0", _                 ' 5:SOR区分（通常）
                shinyo, _              ' 6:信用区分（文字列）
                qty, _                 ' 7:注文数量（数値）
                "0", _                 ' 8:価格区分（成行）
                0, _                   ' 9:注文価格（成行なので 0）
                "1", _                 ' 10:執行条件（本日中）
                "", _                  ' 11:注文期限（空）
                "0", _                 ' 12:口座区分（特定）
                tatebi, _              ' 13:建日（文字列）
                tanka, _               ' 14:建単価（数値）
                marketCode, _          ' 15:建市場（数値）
                0, _                   ' 16:逆指値条件価格
                "", _                  ' 17:逆指値条件区分
                "", _                  ' 18:逆指値価格区分
                0 _                    ' 19:逆指値価格
            )

    Call AppendLog(code, "DoRepay result=" & CStr(result))
    DoRepay = True
End Function


Sub AppendLog(code As String, message As String)
    Dim ws As Worksheet
    Dim nextRow As Long

    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("Logs")
    On Error GoTo 0

    If ws Is Nothing Then
        MsgBox "Logs シートが見つかりません。", vbExclamation
        Exit Sub
    End If

    nextRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).row + 1
    If nextRow < 2 Then nextRow = 2 ' ヘッダーが1行目にある前提

    With ws
        .Cells(nextRow, 1).Value = Now
        .Cells(nextRow, 2).Value = code
        .Cells(nextRow, 3).Value = message
    End With
End Sub


Sub ClearLogs()
    Dim ws As Worksheet

    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("Logs")
    On Error GoTo 0

    If ws Is Nothing Then
        MsgBox "Logs シートが見つかりません。", vbExclamation
        Exit Sub
    End If

    ' 2行目以降を削除（ヘッダーは残す）
    ws.Rows("2:" & ws.Rows.Count).ClearContents
End Sub


Function FindPositionRow(code As String) As Long
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim r As Long

    Set ws = ThisWorkbook.Sheets("Positions")
    lastRow = ws.Cells(ws.Rows.Count, "A").End(xlUp).Row

    ' 最終行が '-------- の場合は1行上から検索開始
    If ws.Cells(lastRow, "A").Value = "--------" Then
        lastRow = lastRow - 1
    End If

    ' 下から上へ検索（最新の建玉を優先）
    For r = lastRow To 3 Step -1
        If ws.Cells(r, "A").Value = code Then
            FindPositionRow = r
            Exit Function
        End If
    Next r

    FindPositionRow = 0
End Function

